---
import '../styles/global.css';
---

<html lang="es">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>TS MP3 Downloader - 100% Local</title>
</head>
<body>
    <!-- Terminal Falso (Izquierda) -->
    <div id="terminal">
        <div class="terminal-header">
            <span>Terminal de Análisis</span>
            <span id="terminalStatus">IDLE</span>
        </div>
        <div class="terminal-body" id="logContainer">
            <div class="log-entry"><span class="log-time">[00:00:00]</span> Bienvenido al Laboratorio v0.0.9</div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
        <div class="container">
            <div class="version">v0.1.0</div>
            <h1>YouTube to MP3</h1>
            <p class="subtitle"></p>

            <div id="thumbnailContainer">
                <img id="thumbnailImg" src="" alt="Preview" />
                <div class="thumbnail-overlay"></div>
            </div>

            <form id="downloadForm">
                <div class="input-group">
                    <label for="url">URL del Video de YouTube</label>
                    <input 
                        type="text" 
                        id="url" 
                        name="url" 
                        placeholder="https://www.youtube.com/watch?v=..." 
                        required 
                    />
                </div>
                <button type="submit" id="downloadBtn">
                    <span id="btnText">Descargar MP3</span>
                </button>
            </form>

            <div id="status"></div>

            <div id="analysisSection">
                <h2>The Audio Analysis Lab</h2>
                <div class="analysis-grid">
                    <div class="analysis-card" id="cardA">
                        <h3>Essentia.js (A)</h3>
                        <div class="analysis-value" id="bpmA">--</div>
                        <div class="analysis-key" id="keyA">Clave: --</div>
                        <div class="analysis-status" id="statusA">Esperando...</div>
                    </div>
                    <div class="analysis-card" id="cardB">
                        <h3>Realtime BPM (B)</h3>
                        <div class="analysis-value" id="bpmB">--</div>
                        <div class="analysis-key" id="keyB">Solo Ritmo</div>
                        <div class="analysis-status" id="statusB">Esperando...</div>
                    </div>
                    <div class="analysis-card" id="cardC">
                        <h3>Aubio (C)</h3>
                        <div class="analysis-value" id="bpmC">--</div>
                        <div class="analysis-key" id="keyC">Clave: --</div>
                        <div class="analysis-status" id="statusC">Esperando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Sistema de Logs para Terminal Falsa ---
        const logContainer = document.querySelector('#logContainer');
        const termStatus = document.querySelector('#terminalStatus');

        function log(msg: string, type: 'info'|'warn'|'error' = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
            logContainer?.appendChild(entry);
            logContainer?.scrollTo(0, logContainer.scrollHeight);
        }

        const form = document.querySelector('#downloadForm');
        const statusDiv = document.querySelector('#status');
        const btn = document.querySelector('#downloadBtn');
        const btnText = document.querySelector('#btnText');
        const urlInput = document.querySelector('#url') as HTMLInputElement;
        const thumbContainer = document.querySelector('#thumbnailContainer') as HTMLElement;
        const thumbImg = document.querySelector('#thumbnailImg') as HTMLImageElement;

        function getYouTubeID(url: string) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        urlInput?.addEventListener('input', () => {
            const id = getYouTubeID(urlInput.value);
            if (id) {
                thumbImg.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
                thumbContainer.style.display = 'block';
                log(`Video ID detectado: ${id}`);
            } else {
                thumbContainer.style.display = 'none';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = urlInput.value;
            if (!url) return;

            statusDiv.style.display = 'block';
            statusDiv.className = 'status-info';
            statusDiv.innerHTML = '<span class="loader"></span> Descargando...';
            btn.disabled = true;
            log(`Iniciando descarga: ${url}`);

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.className = 'status-success';
                    statusDiv.innerHTML = `✅ ¡Descarga completada!`;
                    log('Descarga OK. Iniciando proceso de laboratorio.');
                    startAnalysis(result.filename);
                } else {
                    statusDiv.className = 'status-error';
                    statusDiv.innerHTML = `❌ Error: ${result.error}`;
                    log(`Error: ${result.error}`, 'error');
                }
            } catch (err: any) {
                log(`Error de red: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Descargar MP3';
            }
        });

        async function startAnalysis(filename: string) {
            const analysisSection = document.querySelector('#analysisSection') as HTMLElement;
            analysisSection.style.display = 'block';
            termStatus!.textContent = 'BUSY';
            log(`Analizando archivo: ${filename}`);

            ['A', 'B', 'C'].forEach(id => {
                document.querySelector(`#bpm${id}`)!.textContent = '...';
                document.querySelector(`#status${id}`)!.textContent = 'Analizando...';
            });

            try {
                log('Obteniendo buffet de audio...');
                const response = await fetch(`/api/get-audio?filename=${encodeURIComponent(filename)}`);
                const arrayBuffer = await response.arrayBuffer();

                const audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 44100 });
                log('Decodificando (puede tardar)...');
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const channelData = audioBuffer.getChannelData(0);
                log(`Audio decodificado. Duración: ${Math.round(audioBuffer.duration)}s`);

                runEssentia(channelData, audioBuffer.sampleRate);
                runRealtimeBPM(audioBuffer);
                runAubio(channelData, audioBuffer.sampleRate);

            } catch (err: any) {
                log(`Fallo crítico: ${err.message}`, 'error');
                termStatus!.textContent = 'ERROR';
            }
        }

        // --- Motores (Fixes v0.1.0) ---

        async function runEssentia(signal: Float32Array, sampleRate: number) {
            log('Cargando Motor A (Essentia)...');
            try {
                // Essentia v0.1.3 exported via CJS/UMD
                const mod: any = await import('essentia.js');
                log('Módulo Essentia importado. Buscando constructor...');
                
                // Handle different interop scenarios
                const Essentia = mod.Essentia || mod.default?.Essentia;
                const EssentiaWASM = mod.EssentiaWASM || mod.default?.EssentiaWASM;

                if (!Essentia) throw new Error('No se encontró el constructor Essentia');
                
                const essentia = new Essentia(EssentiaWASM);
                log('Instancia de Essentia creada.');
                
                const vector = essentia.arrayToVector(signal);
                const bpmRes = essentia.PercivalBPM(vector);
                const keyRes = essentia.KeyExtractor(vector);

                document.querySelector('#bpmA')!.textContent = Math.round(bpmRes.bpm).toString();
                document.querySelector('#keyA')!.textContent = `Clave: ${keyRes.key} ${keyRes.scale}`;
                document.querySelector('#statusA')!.textContent = '✅ OK';
                log(`Motor A listo: ${Math.round(bpmRes.bpm)} BPM`);
            } catch (e: any) {
                log(`Error Motor A: ${e.message}`, 'error');
                document.querySelector('#statusA')!.textContent = '❌ Falló';
            }
        }

        async function runRealtimeBPM(audioBuffer: AudioBuffer) {
            log('Cargando Motor B (Realtime)...');
            try {
                const mod: any = await import('realtime-bpm-analyzer');
                log('Módulo RealtimeBPM importado.');
                
                // v5 uses named exports or default
                const analyze = mod.analyze || mod.default?.analyze;
                if (!analyze) throw new Error('No se encontró la función analyze');

                const results = await analyze(audioBuffer);
                if (results && results.length > 0) {
                    document.querySelector('#bpmB')!.textContent = Math.round(results[0].tempo).toString();
                    document.querySelector('#statusB')!.textContent = '✅ OK';
                    log(`Motor B listo: ${Math.round(results[0].tempo)} BPM`);
                } else {
                    log('Motor B: No se detectaron picos.', 'warn');
                    document.querySelector('#statusB')!.textContent = '❓ Nulo';
                }
            } catch (e: any) {
                log(`Error Motor B: ${e.message}`, 'error');
                document.querySelector('#statusB')!.textContent = '❌ Falló';
            }
        }

        async function runAubio(signal: Float32Array, sampleRate: number) {
            log('Cargando Motor C (Aubio)...');
            try {
                const aubiojs = (await import('aubiojs')).default;
                const aubio = await aubiojs();
                
                // Usamos una ventana de 2048 para más estabilidad
                const winSize = 2048;
                const hopSize = 512;
                const tempo = new aubio.Tempo(winSize, hopSize, sampleRate);
                
                let bpms: number[] = [];
                for (let i = 0; i < signal.length; i += hopSize) {
                    const frame = signal.slice(i, i + hopSize);
                    if (frame.length === hopSize) {
                        if (tempo.do(frame)) {
                            const b = tempo.getBpm();
                            // Filtro para evitar ruido
                            if (b > 40 && b < 220) bpms.push(b);
                        }
                    }
                }
                
                if (bpms.length > 0) {
                    bpms.sort((a, b) => a - b);
                    const median = bpms[Math.floor(bpms.length / 2)];
                    
                    // Si el BPM detectado es sospechoso (ej. 126 cuando es 83), intentamos detectar armónicos
                    // Pero por ahora, reportamos la mediana pura.
                    log(`Motor C detectó ${bpms.length} picos. Mediana: ${median.toFixed(1)}`);
                    
                    document.querySelector('#bpmC')!.textContent = Math.round(median).toString();
                    document.querySelector('#statusC')!.textContent = '✅ OK';
                } else {
                    log('Motor C: Nulo', 'warn');
                }
            } catch (e: any) {
                log(`Error Motor C: ${e.message}`, 'error');
                document.querySelector('#statusC')!.textContent = '❌ Falló';
            } finally {
                if (termStatus!.textContent !== 'ERROR') termStatus!.textContent = 'IDLE';
            }
        }
    </script>
</body>
</html>
