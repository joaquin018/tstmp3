---
import '../styles/global.css';
import Terminal from '../components/Terminal.astro';
import DropOverlay from '../components/DropOverlay.astro';
import YouTubeForm from '../components/YouTubeForm.astro';
import AnalysisSection from '../components/AnalysisSection.astro';
---

<html lang="es">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>TS MP3 Downloader - 100% Local</title>
    
    <script is:inline src="/lib/tfjs/tf.min.js"></script>
    <script is:inline src="/lib/essentia/essentia-wasm.umd.js"></script>
    <script is:inline src="/lib/essentia/essentia.js-core.umd.js"></script>
    <script is:inline src="/lib/essentia/essentia.js-extractor.umd.js"></script>
    <script is:inline src="/lib/essentia/essentia.js-model.umd.js"></script>
</head>
<body>
    <Terminal />
    <DropOverlay />

    <div class="main-content">
        <div class="container">
            <div class="version">v0.2.5</div>
            <h1>YouTube to MP3</h1>
            <p class="subtitle"></p>

            <YouTubeForm />
            <AnalysisSection />
        </div>
    </div>

    <script>
        import { log } from '../scripts/logger';
        import { resetResults } from '../scripts/consensus';
        import { runAnalysisFlow, runStructuralMapping, setAudioState } from '../scripts/audioProcessor';

        window.addEventListener('audio-ready', async (e: any) => {
            const { filename, buffer } = e.detail;
            await startAnalysis(filename, buffer);
        });

        async function startAnalysis(filename: string | null, externalBuffer: ArrayBuffer | null = null) {
            const analysisSection = document.querySelector('#analysisSection') as HTMLElement;
            const termStatus = document.querySelector('#terminalStatus');
            
            if (analysisSection) analysisSection.style.display = 'block';
            if (termStatus) termStatus.textContent = 'BUSY';

            resetResults();

            try {
                let arrayBuffer: ArrayBuffer;

                if (externalBuffer) {
                    arrayBuffer = externalBuffer;
                } else if (filename) {
                    log(`ðŸ“¥ Descargando audio: ${filename}`);
                    const response = await fetch(`/api/get-audio?filename=${encodeURIComponent(filename)}`);
                    arrayBuffer = await response.arrayBuffer();
                } else {
                    throw new Error('No hay fuente de audio vÃ¡lida.');
                }

                const audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 44100 });
                log('ðŸ§  Decodificando audio...');
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const channelData = audioBuffer.getChannelData(0);
                const totalDuration = Math.round(audioBuffer.duration);
                log(`ðŸ“Š Audio decodificado. DuraciÃ³n: ${totalDuration}s`);

                const mapping = await runStructuralMapping(channelData, audioBuffer.sampleRate);
                
                setAudioState({
                    signal: channelData,
                    sampleRate: audioBuffer.sampleRate,
                    totalDuration: totalDuration,
                    lufsRanks: mapping.lufsRanks,
                    currentStart: -1
                });

                runAnalysisFlow();
            } catch (err: any) {
                log(`ðŸ›‘ Fallo en anÃ¡lisis: ${err.message}`, 'error');
                if (termStatus) termStatus.textContent = 'ERROR';
            }
        }

        // Shortcut Terminal
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'l') {
                document.querySelector('#terminal')?.classList.toggle('hidden');
            }
        });
    </script>
</body>
</html>
