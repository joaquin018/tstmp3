---
import '../styles/global.css';
---

<html lang="es">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>TS MP3 Downloader - 100% Local</title>
</head>
<body>
    <div class="container">
        <div class="version">v0.0.7</div>
        <h1>YouTube to MP3</h1>
        <p class="subtitle"></p>

        <div id="thumbnailContainer">
            <img id="thumbnailImg" src="" alt="Preview" />
            <div class="thumbnail-overlay"></div>
        </div>

        <form id="downloadForm">
            <div class="input-group">
                <label for="url">URL del Video de YouTube</label>
                <input 
                    type="text" 
                    id="url" 
                    name="url" 
                    placeholder="https://www.youtube.com/watch?v=..." 
                    required 
                />
            </div>
            <button type="submit" id="downloadBtn">
                <span id="btnText">Descargar MP3</span>
            </button>
        </form>

        <div id="status"></div>

        <div id="analysisSection">
            <h2>The Audio Analysis Lab</h2>
            <div class="analysis-grid">
                <div class="analysis-card" id="cardA">
                    <h3>Essentia.js (A)</h3>
                    <div class="analysis-value" id="bpmA">--</div>
                    <div class="analysis-key" id="keyA">Clave: --</div>
                    <div class="analysis-status" id="statusA">Esperando...</div>
                </div>
                <div class="analysis-card" id="cardB">
                    <h3>Realtime BPM (B)</h3>
                    <div class="analysis-value" id="bpmB">--</div>
                    <div class="analysis-key" id="keyB">Solo Ritmo</div>
                    <div class="analysis-status" id="statusB">Esperando...</div>
                </div>
                <div class="analysis-card" id="cardC">
                    <h3>Aubio (C)</h3>
                    <div class="analysis-value" id="bpmC">--</div>
                    <div class="analysis-key" id="keyC">Clave: --</div>
                    <div class="analysis-status" id="statusC">Esperando...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.querySelector('#downloadForm');
        const statusDiv = document.querySelector('#status');
        const btn = document.querySelector('#downloadBtn');
        const btnText = document.querySelector('#btnText');
        const urlInput = document.querySelector('#url') as HTMLInputElement;
        const thumbContainer = document.querySelector('#thumbnailContainer') as HTMLElement;
        const thumbImg = document.querySelector('#thumbnailImg') as HTMLImageElement;

        // Function to extract YouTube ID
        function getYouTubeID(url: string) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        urlInput?.addEventListener('input', () => {
            const id = getYouTubeID(urlInput.value);
            if (id) {
                thumbImg.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
                thumbContainer.style.display = 'block';
            } else {
                thumbContainer.style.display = 'none';
                thumbImg.src = '';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const urlInput = document.querySelector('#url');
            const url = urlInput ? (urlInput as HTMLInputElement).value : '';

            if (!url) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status-error';
                statusDiv.innerHTML = '❌ Por favor, ingresa una URL válida.';
                return;
            }

            statusDiv.style.display = 'block';
            statusDiv.className = 'status-info';
            statusDiv.innerHTML = '<span class="loader"></span> Procesando descarga...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const text = await response.text();
                let result = JSON.parse(text);

                if (response.ok) {
                    statusDiv.className = 'status-success';
                    statusDiv.innerHTML = `✅ ¡Descarga completada! Archivo guardado.`;
                    startAnalysis(result.filename);
                } else {
                    statusDiv.className = 'status-error';
                    statusDiv.innerHTML = `❌ Error: ${result.error || 'Algo salió mal'}`;
                }
            } catch (err: any) {
                statusDiv.className = 'status-error';
                statusDiv.innerHTML = `❌ Error: ${err.message}`;
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Descargar MP3';
            }
        });

        async function startAnalysis(filename: string) {
            const analysisSection = document.querySelector('#analysisSection') as HTMLElement;
            analysisSection.style.display = 'block';

            ['A', 'B', 'C'].forEach(id => {
                document.querySelector(`#bpm${id}`)!.textContent = '...';
                document.querySelector(`#key${id}`)! .textContent = id === 'B' ? 'Solo Ritmo' : 'Clave: --';
                document.querySelector(`#status${id}`)!.textContent = 'Cargando...';
            });

            try {
                const response = await fetch(`/api/get-audio?filename=${encodeURIComponent(filename)}`);
                const arrayBuffer = await response.arrayBuffer();

                const audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 44100 });
                document.querySelector('#statusA')!.textContent = 'Decodificando...';
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const channelData = audioBuffer.getChannelData(0);

                runEssentia(channelData, audioBuffer.sampleRate);
                runRealtimeBPM(audioBuffer);
                runAubio(channelData, audioBuffer.sampleRate);

            } catch (err: any) {
                console.error('Análisis fallido:', err);
            }
        }

        // --- Engine A: Essentia.js ---
        async function runEssentia(signal: Float32Array, sampleRate: number) {
            const status = document.querySelector('#statusA')!;
            const bpmVal = document.querySelector('#bpmA')!;
            const keyVal = document.querySelector('#keyA')!;
            status.textContent = 'Analizando...';

            try {
                // Using specific distribution files to avoid dynamic import issues
                const { Essentia } = await import('essentia.js/dist/essentia.js-core.es.js');
                const { EssentiaWASM } = await import('essentia.js/dist/essentia-wasm.es.js');
                
                const essentia = new Essentia(EssentiaWASM);
                const vector = essentia.arrayToVector(signal);
                const results = essentia.PercivalBPM(vector);
                const keyData = essentia.KeyExtractor(vector);

                bpmVal.textContent = Math.round(results.bpm).toString();
                keyVal.textContent = `Clave: ${keyData.key} ${keyData.scale}`;
                status.textContent = '✅ Finalizado';
            } catch (e: any) {
                status.textContent = '❌ Error Motor A';
            }
        }

        // --- Engine B: Realtime BPM Analyzer ---
        async function runRealtimeBPM(audioBuffer: AudioBuffer) {
            const status = document.querySelector('#statusB')!;
            const bpmVal = document.querySelector('#bpmB')!;
            status.textContent = 'Analizando...';

            try {
                const RealtimeMod: any = await import('realtime-bpm-analyzer');
                // The analyze function might be under a property or part of the export
                const analyzeFn = RealtimeMod.analyze || RealtimeMod.default?.analyze;
                
                const results = await analyzeFn(audioBuffer);
                if (results && results.length > 0) {
                    bpmVal.textContent = Math.round(results[0].tempo).toString();
                    status.textContent = '✅ Finalizado';
                } else {
                    status.textContent = '❓ Sin datos';
                }
            } catch (e: any) {
                status.textContent = '❌ Error Motor B';
            }
        }

        // --- Engine C: Aubiojs ---
        async function runAubio(signal: Float32Array, sampleRate: number) {
            const status = document.querySelector('#statusC')!;
            const bpmVal = document.querySelector('#bpmC')!;
            status.textContent = 'Analizando...';

            try {
                const aubiojs = (await import('aubiojs')).default;
                const aubio = await aubiojs();
                
                const winSize = 2048;
                const hopSize = 512;
                const tempo = new aubio.Tempo(winSize, hopSize, sampleRate);
                
                let bpms: number[] = [];
                for (let i = 0; i < signal.length; i += hopSize) {
                    const frame = signal.slice(i, i + hopSize);
                    if (frame.length === hopSize) {
                        if (tempo.do(frame)) {
                            const b = tempo.getBpm();
                            if (b > 30 && b < 300) bpms.push(b);
                        }
                    }
                }
                
                if (bpms.length > 0) {
                    // Calculate Median for better accuracy
                    bpms.sort((a, b) => a - b);
                    const median = bpms[Math.floor(bpms.length / 2)];
                    bpmVal.textContent = Math.round(median).toString();
                    status.textContent = '✅ Finalizado';
                } else {
                    status.textContent = '❓ Sin datos';
                }
            } catch (e: any) {
                status.textContent = '❌ Error Motor C';
            }
        }
    </script>
</body>
</html>
