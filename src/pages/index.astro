---
import '../styles/global.css';
---

<html lang="es">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>TS MP3 Downloader - 100% Local</title>
</head>
<body>
    <div class="container">
    <!-- Terminal Falso (Izquierda) -->
    <div id="terminal">
        <div class="terminal-header">
            <span>Terminal de Análisis</span>
            <span id="terminalStatus">IDLE</span>
        </div>
        <div class="terminal-body" id="logContainer">
            <div class="log-entry"><span class="log-time">[00:00:00]</span> Bienvenido al Laboratorio v0.0.8</div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
        <div class="container">
            <div class="version">v0.0.8</div>
            <h1>YouTube to MP3</h1>
            <p class="subtitle"></p>

            <div id="thumbnailContainer">
                <img id="thumbnailImg" src="" alt="Preview" />
                <div class="thumbnail-overlay"></div>
            </div>

            <form id="downloadForm">
                <div class="input-group">
                    <label for="url">URL del Video de YouTube</label>
                    <input 
                        type="text" 
                        id="url" 
                        name="url" 
                        placeholder="https://www.youtube.com/watch?v=..." 
                        required 
                    />
                </div>
                <button type="submit" id="downloadBtn">
                    <span id="btnText">Descargar MP3</span>
                </button>
            </form>

            <div id="status"></div>

            <div id="analysisSection">
                <h2>The Audio Analysis Lab</h2>
                <div class="analysis-grid">
                    <div class="analysis-card" id="cardA">
                        <h3>Essentia.js (A)</h3>
                        <div class="analysis-value" id="bpmA">--</div>
                        <div class="analysis-key" id="keyA">Clave: --</div>
                        <div class="analysis-status" id="statusA">Esperando...</div>
                    </div>
                    <div class="analysis-card" id="cardB">
                        <h3>Realtime BPM (B)</h3>
                        <div class="analysis-value" id="bpmB">--</div>
                        <div class="analysis-key" id="keyB">Solo Ritmo</div>
                        <div class="analysis-status" id="statusB">Esperando...</div>
                    </div>
                    <div class="analysis-card" id="cardC">
                        <h3>Aubio (C)</h3>
                        <div class="analysis-value" id="bpmC">--</div>
                        <div class="analysis-key" id="keyC">Clave: --</div>
                        <div class="analysis-status" id="statusC">Esperando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Sistema de Logs para Terminal Falsa ---
        const logContainer = document.querySelector('#logContainer');
        const termStatus = document.querySelector('#terminalStatus');

        function log(msg: string, type: 'info'|'warn'|'error' = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
            logContainer?.appendChild(entry);
            logContainer?.scrollTo(0, logContainer.scrollHeight);
            console.log(`[TERM] ${msg}`);
        }

        const form = document.querySelector('#downloadForm');
        const statusDiv = document.querySelector('#status');
        const btn = document.querySelector('#downloadBtn');
        const btnText = document.querySelector('#btnText');
        const urlInput = document.querySelector('#url') as HTMLInputElement;
        const thumbContainer = document.querySelector('#thumbnailContainer') as HTMLElement;
        const thumbImg = document.querySelector('#thumbnailImg') as HTMLImageElement;

        function getYouTubeID(url: string) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        urlInput?.addEventListener('input', () => {
            const id = getYouTubeID(urlInput.value);
            if (id) {
                thumbImg.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
                thumbContainer.style.display = 'block';
                log(`Detectado video ID: ${id}`);
            } else {
                thumbContainer.style.display = 'none';
                thumbImg.src = '';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = urlInput.value;
            if (!url) return;

            statusDiv.style.display = 'block';
            statusDiv.className = 'status-info';
            statusDiv.innerHTML = '<span class="loader"></span> Procesando descarga...';
            btn.disabled = true;
            log(`Iniciando descarga: ${url}`);

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const text = await response.text();
                let result = JSON.parse(text);

                if (response.ok) {
                    statusDiv.className = 'status-success';
                    statusDiv.innerHTML = `✅ ¡Descarga completada!`;
                    log('Descarga finalizada con éxito en el servidor.');
                    startAnalysis(result.filename);
                } else {
                    statusDiv.className = 'status-error';
                    statusDiv.innerHTML = `❌ Error: ${result.error}`;
                    log(`Error servidor: ${result.error}`, 'error');
                }
            } catch (err: any) {
                statusDiv.className = 'status-error';
                statusDiv.innerHTML = `❌ Error: ${err.message}`;
                log(`Fallo de red: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Descargar MP3';
            }
        });

        async function startAnalysis(filename: string) {
            const analysisSection = document.querySelector('#analysisSection') as HTMLElement;
            analysisSection.style.display = 'block';
            termStatus!.textContent = 'BUSY';
            log(`Empezando análisis de: ${filename}`);

            ['A', 'B', 'C'].forEach(id => {
                document.querySelector(`#bpm${id}`)!.textContent = '...';
                document.querySelector(`#status${id}`)!.textContent = 'Analizando...';
            });

            try {
                log('Recuperando buffet de audio desde el servidor...');
                const response = await fetch(`/api/get-audio?filename=${encodeURIComponent(filename)}`);
                const arrayBuffer = await response.arrayBuffer();

                const audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 44100 });
                log('Decodificando AudioData (esto puede tardar unos segundos)...');
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const channelData = audioBuffer.getChannelData(0);
                log(`Audio decodificado: ${Math.round(audioBuffer.duration)}s de duración.`);

                // Ejecutar en paralelo
                runEssentia(channelData, audioBuffer.sampleRate);
                runRealtimeBPM(audioBuffer);
                runAubio(channelData, audioBuffer.sampleRate);

            } catch (err: any) {
                log(`Error en Laboratorio: ${err.message}`, 'error');
                termStatus!.textContent = 'ERROR';
            }
        }

        // --- Motores (Ajustados para v0.0.8) ---
        async function runEssentia(signal: Float32Array, sampleRate: number) {
            log('Iniciando Motor A (Essentia.js)...');
            try {
                const { Essentia } = await import('essentia.js/dist/essentia.js-core.es.js');
                const { EssentiaWASM } = await import('essentia.js/dist/essentia-wasm.es.js');
                const essentia = new Essentia(EssentiaWASM);
                
                const vector = essentia.arrayToVector(signal);
                const bpmRes = essentia.PercivalBPM(vector);
                const keyRes = essentia.KeyExtractor(vector);

                document.querySelector('#bpmA')!.textContent = Math.round(bpmRes.bpm).toString();
                document.querySelector('#keyA')!.textContent = `Clave: ${keyRes.key} ${keyRes.scale}`;
                document.querySelector('#statusA')!.textContent = '✅ OK';
                log(`Essentia finalizado: ${Math.round(bpmRes.bpm)} BPM`);
            } catch (e: any) {
                log(`Fallo Essentia: ${e.message}`, 'error');
                document.querySelector('#statusA')!.textContent = '❌ Falló';
            }
        }

        async function runRealtimeBPM(audioBuffer: AudioBuffer) {
            log('Iniciando Motor B (Realtime BPM)...');
            try {
                const RealtimeBPM: any = await import('realtime-bpm-analyzer');
                const results = await RealtimeBPM.analyze(audioBuffer);
                if (results && results.length > 0) {
                    document.querySelector('#bpmB')!.textContent = Math.round(results[0].tempo).toString();
                    document.querySelector('#statusB')!.textContent = '✅ OK';
                    log(`Realtime BPM finalizado: ${Math.round(results[0].tempo)} BPM`);
                } else {
                    log('Realtime BPM no encontró un patrón rítmico claro.', 'warn');
                    document.querySelector('#statusB')!.textContent = '❓ Nulo';
                }
            } catch (e: any) {
                log(`Fallo Realtime BPM: ${e.message}`, 'error');
                document.querySelector('#statusB')!.textContent = '❌ Falló';
            }
        }

        async function runAubio(signal: Float32Array, sampleRate: number) {
            log('Iniciando Motor C (Aubio.js)...');
            try {
                const aubiojs = (await import('aubiojs')).default;
                const aubio = await aubiojs();
                
                // Reducimos winSize para ser más sensible a tempos lentos (como 83 BPM)
                const winSize = 1024;
                const hopSize = 512;
                const tempo = new aubio.Tempo(winSize, hopSize, sampleRate);
                
                let bpms: number[] = [];
                for (let i = 0; i < signal.length; i += hopSize) {
                    const frame = signal.slice(i, i + hopSize);
                    if (frame.length === hopSize) {
                        if (tempo.do(frame)) {
                            const b = tempo.getBpm();
                            if (b > 30 && b < 250) bpms.push(b);
                        }
                    }
                }
                
                if (bpms.length > 0) {
                    bpms.sort((a, b) => a - b);
                    const median = bpms[Math.floor(bpms.length / 2)];
                    // LOG EXTRA: Mostrar todos los BPMs detectados para debugear
                    log(`Aubio detección cruda: ${bpms.length} puntos. Mediana: ${median.toFixed(1)}`);
                    
                    document.querySelector('#bpmC')!.textContent = Math.round(median).toString();
                    document.querySelector('#statusC')!.textContent = '✅ OK';
                } else {
                    log('Aubio no detectó ningún pulso.', 'warn');
                }
            } catch (e: any) {
                log(`Fallo Aubio: ${e.message}`, 'error');
                document.querySelector('#statusC')!.textContent = '❌ Falló';
            } finally {
                termStatus!.textContent = 'IDLE';
            }
        }
    </script>
</body>
</html>
