---
import '../styles/global.css';
---

<html lang="es">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>TS MP3 Downloader - 100% Local</title>
    
    <!-- Librer√≠as de An√°lisis Audio (Full Extension v0.1.7) -->
    <script is:inline src="/lib/essentia/essentia-wasm.web.js"></script>
    <script is:inline src="/lib/essentia/essentia.js-core.umd.js"></script>
    <script is:inline src="/lib/essentia/essentia.js-extractor.umd.js"></script>
</head>
<body>
    <!-- Terminal Falso (Izquierda) -->
    <div id="terminal">
        <div class="terminal-header">
            <div class="terminal-title-group">
                 <span>Terminal de An√°lisis</span>
                 <span id="terminalStatus">IDLE</span>
            </div>
            <div class="terminal-actions">
                <button id="clearLogs" title="Limpiar logs">üßπ</button>
                <button id="toggleExpand" title="Expandir/Contraer">‚ÜîÔ∏è</button>
                <button id="downloadLogs" title="Descargar Log Completo">üíæ</button>
            </div>
        </div>
        <div class="terminal-body" id="logContainer">
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
        <div class="container">
            <div class="version">v0.1.7</div>
            <h1>YouTube to MP3</h1>
            <p class="subtitle"></p>

            <div id="thumbnailContainer">
                <img id="thumbnailImg" src="" alt="Preview" />
                <div class="thumbnail-overlay"></div>
            </div>

            <form id="downloadForm">
                <div class="input-group">
                    <label for="url">URL del Video de YouTube</label>
                    <input 
                        type="text" 
                        id="url" 
                        name="url" 
                        placeholder="https://www.youtube.com/watch?v=..." 
                        required 
                    />
                </div>
                <button type="submit" id="downloadBtn">
                    <span id="btnText">Descargar MP3</span>
                </button>
            </form>

            <div id="status"></div>

            <div id="analysisSection">
                <h2>The Audio Analysis Lab</h2>
                <div class="engine-card consensus" id="consensus-card">
                    <div class="engine-name">üèÜ Consenso Final</div>
                    <div class="bpm-value" id="bpmConsensus">--</div>
                    <div class="key-value" id="keyConsensus">Buscando acuerdo...</div>
                </div>
                <div class="analysis-grid">
                    <div class="analysis-card" id="cardA">
                        <h3>Essentia.js (A)</h3>
                        <div class="analysis-value" id="bpmA">--</div>
                        <div class="analysis-key" id="keyA">Clave: --</div>
                        <div class="analysis-status" id="statusA">Esperando...</div>
                    </div>
                    <div class="analysis-card" id="cardB">
                        <h3>Realtime BPM (B)</h3>
                        <div class="analysis-value" id="bpmB">--</div>
                        <div class="analysis-key" id="keyB">Solo Ritmo</div>
                        <div class="analysis-status" id="statusB">Esperando...</div>
                    </div>
                    <div class="analysis-card" id="cardC">
                        <h3>Aubio (C)</h3>
                        <div class="analysis-value" id="bpmC">--</div>
                        <div class="analysis-key" id="keyC">Clave: --</div>
                        <div class="analysis-status" id="statusC">Esperando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Sistema de Logs Avanzado ---
        const logContainer = document.querySelector('#logContainer');
        const termStatus = document.querySelector('#terminalStatus');
        const fullLogs: any[] = [];

        function log(msg: string, type: 'info'|'warn'|'error' = 'info', data: any = null) {
            const time = new Date().toLocaleTimeString();
            fullLogs.push({ time, msg, type, data, timestamp: Date.now() });

            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            let html = `<span class="log-time">[${time}]</span> ${msg}`;
            
            if (data) {
                const dataStr = typeof data === 'object' ? JSON.stringify(data, null, 2) : String(data);
                html += ` <span class="log-toggle" onclick="this.nextElementSibling.classList.toggle('visible')">üîç</span>`;
                html += `<pre class="log-data">${dataStr}</pre>`;
            }
            
            entry.innerHTML = html;
            logContainer?.appendChild(entry);
            logContainer?.scrollTo(0, logContainer.scrollHeight);
            
            if (type === 'error') console.error(`[LOG ERROR] ${msg}`, data);
            else console.log(`[LOG ${type.toUpperCase()}] ${msg}`, data);
        }

        // Terminal Actions
        document.querySelector('#clearLogs')?.addEventListener('click', () => {
            if (logContainer) logContainer.innerHTML = '';
            fullLogs.length = 0;
            log('Logs limpiados.');
        });

        document.querySelector('#toggleExpand')?.addEventListener('click', () => {
            const term = document.querySelector('#terminal') as HTMLElement;
            term.classList.toggle('expanded');
        });

        document.querySelector('#downloadLogs')?.addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(fullLogs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analysis_log_${new Date().toISOString()}.json`;
            a.click();
        });

        const form = document.querySelector('#downloadForm');
        const statusDiv = document.querySelector('#status');
        const btn = document.querySelector('#downloadBtn');
        const btnText = document.querySelector('#btnText');
        const urlInput = document.querySelector('#url') as HTMLInputElement;
        const thumbContainer = document.querySelector('#thumbnailContainer') as HTMLElement;
        const thumbImg = document.querySelector('#thumbnailImg') as HTMLImageElement;

        function getYouTubeID(url: string) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        urlInput?.addEventListener('input', () => {
            const id = getYouTubeID(urlInput.value);
            if (id) {
                thumbImg.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
                thumbContainer.style.display = 'block';
                log(`Video detectado: ${id}`);
            } else {
                thumbContainer.style.display = 'none';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = urlInput.value;
            if (!url) return;

            statusDiv.style.display = 'block';
            statusDiv.className = 'status-info';
            statusDiv.innerHTML = '<span class="loader"></span> Procesando...';
            btn.disabled = true;
            results = { bpmA: null, bpmB: null, bpmC: null };
            document.querySelector('#bpmConsensus')!.textContent = '--';
            document.querySelector('#keyConsensus')!.textContent = 'Buscando acuerdo...';

            log(`‚û°Ô∏è URL enviada: ${url}`);

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.className = 'status-success';
                    statusDiv.innerHTML = `‚úÖ Descarga completada`;
                    log('‚úÖ MP3 listo en servidor. Lanzando Laboratorio...');
                    startAnalysis(result.filename);
                } else {
                    statusDiv.className = 'status-error';
                    statusDiv.innerHTML = `‚ùå Error: ${result.error}`;
                    log(`‚ùå Error servidor: ${result.error}`, 'error');
                }
            } catch (err: any) {
                log(`‚ùå Error de red: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Descargar MP3';
            }
        });

        async function startAnalysis(filename: string) {
            const analysisSection = document.querySelector('#analysisSection') as HTMLElement;
            analysisSection.style.display = 'block';
            termStatus!.textContent = 'BUSY';

            ['A', 'B', 'C'].forEach(id => {
                document.querySelector(`#bpm${id}`)!.textContent = '...';
                document.querySelector(`#status${id}`)!.textContent = 'Analizando...';
            });

            try {
                log(`üì• Descargando buffet: ${filename}`);
                const response = await fetch(`/api/get-audio?filename=${encodeURIComponent(filename)}`);
                const arrayBuffer = await response.arrayBuffer();

                const audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 44100 });
                log('üß† Decodificando audio (CPU intensivo)...');
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const channelData = audioBuffer.getChannelData(0);
                log(`üìä Audio decodificado. Duraci√≥n: ${Math.round(audioBuffer.duration)}s @ 44.1kHz`);

                runEssentia(channelData, audioBuffer.sampleRate);
                runRealtimeBPM(audioBuffer);
                runAubio(channelData, audioBuffer.sampleRate);

            } catch (err: any) {
                log(`üõë Fallo en decodificaci√≥n: ${err.message}`, 'error');
                termStatus!.textContent = 'ERROR';
            }
        }

        // --- Motores (Fixes v0.1.4) ---

        // Global results for consensus
        let results = {
            bpmA: null,
            bpmB: null,
            bpmC: null
        };

        async function runEssentia(signal: Float32Array, sampleRate: number) {
            log('üöÄ Motor A (Essentia): Iniciando v0.1.6...');
            try {
                // In the Web build, sometimes it's just 'EssentiaWasm'
                const Essentia = (window as any).Essentia;
                const EssentiaWASM = (window as any).EssentiaWasm || (window as any).EssentiaWASM || (window as any).essentiaWasm;

                if (!Essentia || !EssentiaWASM) {
                    throw new Error("No se encontr√≥ el constructor de Essentia. Revisa la consola.");
                }

                log('‚öôÔ∏è Inicializando backend WASM v0.1.6...');
                // The web version often exports a factory that auto-loads the .wasm
                const backend = await EssentiaWASM();
                log('‚ú® Creando instancia principal...');
                const essentia = new Essentia(backend);
                log('‚ú® Instancia Essentia creada. Escaneando capacidades...');
                
                const algorithms = essentia.algorithmNames;
                log(`üìä Algoritmos disponibles: ${algorithms.length} detectados`, 'info', {
                    names: algorithms.slice(0, 10).concat(['...']),
                    hasPercival: algorithms.includes('PercivalBPM'),
                    hasRhythm: algorithms.includes('RhythmExtractor2013'),
                    hasKey: algorithms.includes('KeyExtractor')
                });

                const vector = essentia.arrayToVector(signal);
                let bpm = 0;
                let key = 'Unknown';
                let scale = '';

                // --- BPM Extraction with Fallback ---
                try {
                    if (algorithms.includes('PercivalBPM')) {
                        log('ü•Å Usando PercivalBPM...');
                        const res = essentia.PercivalBPM(vector);
                        bpm = Math.round(res.bpm);
                    } else if (algorithms.includes('RhythmExtractor2013')) {
                        log('ü•Å PercivalBPM ausente. Usando RhythmExtractor2013...');
                        const res = essentia.RhythmExtractor2013(vector);
                        bpm = Math.round(res.bpm);
                    } else if (algorithms.includes('BeatTrackerDegara')) {
                        log('ü•Å Usando fallback BeatTrackerDegara...');
                        const res = essentia.BeatTrackerDegara(vector);
                        bpm = Math.round(60 / (res.ticks[1] - res.ticks[0]));
                    } else {
                        throw new Error("No hay algoritmos de BPM compatibles en este build.");
                    }
                } catch (e: any) {
                    log(`‚ö†Ô∏è Fallo en extracci√≥n de BPM: ${e.message}`, 'warn');
                }

                // --- Key Extraction with Fallback ---
                try {
                    if (algorithms.includes('KeyExtractor')) {
                        log('üéπ Usando KeyExtractor...');
                        const res = essentia.KeyExtractor(vector);
                        key = res.key;
                        scale = res.scale;
                    } else {
                        log('üéπ KeyExtractor ausente. Intentando estimaci√≥n base...');
                        // Fallback simple si no hay extractor de clave
                    }
                } catch (e: any) {
                    log(`‚ö†Ô∏è Fallo en extracci√≥n de Clave: ${e.message}`, 'warn');
                }
                
                results.bpmA = bpm;
                
                document.querySelector('#bpmA')!.textContent = bpm > 0 ? bpm.toString() : '--';
                document.querySelector('#keyA')!.textContent = `Clave: ${key} ${scale}`;
                document.querySelector('#statusA')!.textContent = bpm > 0 ? '‚úÖ OK' : '‚ùì Nulo';
                log(`üéØ Motor A finaliz√≥: ${bpm} BPM | ${key} ${scale}`);
                updateConsensus();
            } catch (e: any) {
                log(`‚ùå Fallo Motor A: ${e.message}`, 'error', {
                    errorName: e.name,
                    stack: e.stack,
                    essentiaAvailable: !!(window as any).Essentia,
                    wasmAvailable: !!(window as any).EssentiaWASM
                });
                document.querySelector('#statusA')!.textContent = '‚ùå Error';
            }
        }

        async function runRealtimeBPM(audioBuffer: AudioBuffer) {
            log('üöÄ Motor B (RealtimeBPM): Iniciando...');
            try {
                const mod: any = await import('realtime-bpm-analyzer');
                const analyzeFullBuffer = mod.analyzeFullBuffer || mod.default?.analyzeFullBuffer;

                if (!analyzeFullBuffer) {
                    throw new Error('Funci√≥n analyzeFullBuffer no encontrada en el m√≥dulo.');
                }

                const data = await analyzeFullBuffer(audioBuffer);
                if (data && data.length > 0) {
                    const best = data[0];
                    const bpm = Math.round(best.tempo);
                    results.bpmB = bpm;
                    
                    document.querySelector('#bpmB')!.textContent = bpm.toString();
                    document.querySelector('#statusB')!.textContent = '‚úÖ OK';
                    log(`üéØ Motor B finaliz√≥: ${bpm} BPM (Confianza: ${best.count})`);
                    updateConsensus();
                } else {
                    log('‚ö†Ô∏è Motor B no detect√≥ ritmo claro.', 'warn');
                    document.querySelector('#statusB')!.textContent = '‚ùì Nulo';
                }
            } catch (e: any) {
                log(`‚ùå Fallo Motor B: ${e.message}`, 'error');
                document.querySelector('#statusB')!.textContent = '‚ùå Error';
            }
        }

        async function runAubio(signal: Float32Array, sampleRate: number) {
            log('üöÄ Motor C (Aubio): Iniciando...');
            try {
                const aubiojs = (await import('aubiojs')).default;
                const aubio = await aubiojs();
                
                const winSize = 2048;
                const hopSize = 512;
                
                const tempo = new aubio.Tempo(winSize, hopSize, sampleRate);
                let bpms: number[] = [];
                
                const pitch = new aubio.Pitch('default', winSize, hopSize, sampleRate);
                let pitches: number[] = [];

                for (let i = 0; i < signal.length; i += hopSize) {
                    const frame = signal.slice(i, i + hopSize);
                    if (frame.length === hopSize) {
                        if (tempo.do(frame)) {
                            const b = tempo.getBpm();
                            if (b > 30 && b < 250) bpms.push(b);
                        }
                        const p = pitch.do(frame);
                        if (p > 50 && p < 2000) pitches.push(p);
                    }
                }
                
                if (bpms.length > 0) {
                    bpms.sort((a,b) => a-b);
                    let median = bpms[Math.floor(bpms.length / 2)];
                    
                    // HEUR√çSTICA MEJORADA: Detectar arm√≥nicos comunes
                    // Si la canci√≥n es ~83, Aubio suele dar ~126 (1.5x) o ~166 (2x)
                    // Comprobamos si hay clusters significativos en las versiones divididas.
                    const checkHarmony = (val: number, divisor: number) => {
                        const target = val / divisor;
                        const count = bpms.filter(b => Math.abs(b - target) < 3).length;
                        return count > bpms.length * 0.15; // 15% de los beats sugieren este ritmo
                    };

                    if (checkHarmony(median, 1.5)) {
                        log(`üí° Motor C: Detectada armon√≠a 1.5x. Ajustando ${median.toFixed(0)} -> ${(median/1.5).toFixed(0)}`);
                        median = median / 1.5;
                    } else if (checkHarmony(median, 2)) {
                        log(`üí° Motor C: Detectada armon√≠a 2x. Ajustando ${median.toFixed(0)} -> ${(median/2).toFixed(0)}`);
                        median = median / 2;
                    }

                    const bpm = Math.round(median);
                    results.bpmC = bpm;
                    document.querySelector('#bpmC')!.textContent = bpm.toString();
                    log(`üéØ Motor C finaliz√≥: ${bpm} BPM`);
                    updateConsensus();
                }

                if (pitches.length > 0) {
                    pitches.sort((a,b) => a-b);
                    const avgPitch = pitches[Math.floor(pitches.length/2)];
                    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                    const semitone = 12 * (Math.log(avgPitch / 440) / Math.log(2)) + 69;
                    const noteIndex = Math.round(semitone) % 12;
                    document.querySelector('#keyC')!.textContent = `Clave (Aprox): ${notes[noteIndex]}`;
                }

                document.querySelector('#statusC')!.textContent = '‚úÖ OK';
            } catch (e: any) {
                log(`‚ùå Fallo Motor C: ${e.message}`, 'error');
                document.querySelector('#statusC')!.textContent = '‚ùå Error';
            } finally {
                if (termStatus!.textContent !== 'ERROR') termStatus!.textContent = 'IDLE';
            }
        }

        function updateConsensus() {
            const valid = [results.bpmA, results.bpmB, results.bpmC].filter(b => b !== null) as number[];
            if (valid.length === 0) return;

            // Simple consensus: look for values that are close to each other or multiples
            // We want to find the most likely "true" BPM.
            let bestBpm = valid[0];
            
            // Try to normalize everyone to 60-140 range for comparison
            const normalized = valid.map(b => {
                let n = b;
                while (n > 150) n /= 2;
                while (n < 60) n *= 2;
                return n;
            });

            // Find the average of normalized values if they are close
            // For now, let's just pick the mean of the two closest if available
            if (normalized.length >= 2) {
                normalized.sort((a, b) => a - b);
                // If they are within 5% of each other, they agree!
                if (Math.abs(normalized[1] - normalized[0]) < normalized[0] * 0.05) {
                    bestBpm = Math.round((normalized[0] + normalized[1]) / 2);
                } else if (normalized.length === 3 && Math.abs(normalized[2] - normalized[1]) < normalized[1] * 0.05) {
                    bestBpm = Math.round((normalized[1] + normalized[2]) / 2);
                } else {
                    // No clear consensus, pick the one from Motor B (RealtimeBPM) as it's usually reliable if not doubled
                    bestBpm = normalized[valid.indexOf(results.bpmB!)] || normalized[0];
                }
            } else {
                bestBpm = normalized[0];
            }

            log(`üèÜ Consenso actual: ~${bestBpm} BPM`, 'info');
            document.querySelector('#bpmConsensus')!.textContent = bestBpm.toString();
            
            // For key, let's just pick Essentia's for now as it's the most robust
            const keyA = document.querySelector('#keyA')!.textContent || '';
            if (keyA.includes('Clave:')) {
                document.querySelector('#keyConsensus')!.textContent = keyA;
            }
        }
    </script>
</body>
</html>
