---
import '../styles/global.css';
---

<html lang="es">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>TS MP3 Downloader - 100% Local</title>
</head>
<body>
    <!-- Terminal Falso (Izquierda) -->
    <div id="terminal">
        <div class="terminal-header">
            <span>Terminal de An√°lisis</span>
            <span id="terminalStatus">IDLE</span>
        </div>
        <div class="terminal-body" id="logContainer">
            <div class="log-entry"><span class="log-time">[00:00:00]</span> Bienvenido al Laboratorio v0.0.9</div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
        <div class="container">
            <div class="version">v0.1.1</div>
            <h1>YouTube to MP3</h1>
            <p class="subtitle"></p>

            <div id="thumbnailContainer">
                <img id="thumbnailImg" src="" alt="Preview" />
                <div class="thumbnail-overlay"></div>
            </div>

            <form id="downloadForm">
                <div class="input-group">
                    <label for="url">URL del Video de YouTube</label>
                    <input 
                        type="text" 
                        id="url" 
                        name="url" 
                        placeholder="https://www.youtube.com/watch?v=..." 
                        required 
                    />
                </div>
                <button type="submit" id="downloadBtn">
                    <span id="btnText">Descargar MP3</span>
                </button>
            </form>

            <div id="status"></div>

            <div id="analysisSection">
                <h2>The Audio Analysis Lab</h2>
                <div class="analysis-grid">
                    <div class="analysis-card" id="cardA">
                        <h3>Essentia.js (A)</h3>
                        <div class="analysis-value" id="bpmA">--</div>
                        <div class="analysis-key" id="keyA">Clave: --</div>
                        <div class="analysis-status" id="statusA">Esperando...</div>
                    </div>
                    <div class="analysis-card" id="cardB">
                        <h3>Realtime BPM (B)</h3>
                        <div class="analysis-value" id="bpmB">--</div>
                        <div class="analysis-key" id="keyB">Solo Ritmo</div>
                        <div class="analysis-status" id="statusB">Esperando...</div>
                    </div>
                    <div class="analysis-card" id="cardC">
                        <h3>Aubio (C)</h3>
                        <div class="analysis-value" id="bpmC">--</div>
                        <div class="analysis-key" id="keyC">Clave: --</div>
                        <div class="analysis-status" id="statusC">Esperando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Sistema de Logs para Terminal Falsa ---
        const logContainer = document.querySelector('#logContainer');
        const termStatus = document.querySelector('#terminalStatus');

        function log(msg: string, type: 'info'|'warn'|'error' = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
            logContainer?.appendChild(entry);
            logContainer?.scrollTo(0, logContainer.scrollHeight);
        }

        const form = document.querySelector('#downloadForm');
        const statusDiv = document.querySelector('#status');
        const btn = document.querySelector('#downloadBtn');
        const btnText = document.querySelector('#btnText');
        const urlInput = document.querySelector('#url') as HTMLInputElement;
        const thumbContainer = document.querySelector('#thumbnailContainer') as HTMLElement;
        const thumbImg = document.querySelector('#thumbnailImg') as HTMLImageElement;

        function getYouTubeID(url: string) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        urlInput?.addEventListener('input', () => {
            const id = getYouTubeID(urlInput.value);
            if (id) {
                thumbImg.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
                thumbContainer.style.display = 'block';
                log(`Video detectado: ${id}`);
            } else {
                thumbContainer.style.display = 'none';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = urlInput.value;
            if (!url) return;

            statusDiv.style.display = 'block';
            statusDiv.className = 'status-info';
            statusDiv.innerHTML = '<span class="loader"></span> Procesando...';
            btn.disabled = true;
            log(`‚û°Ô∏è URL enviada: ${url}`);

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.className = 'status-success';
                    statusDiv.innerHTML = `‚úÖ Descarga completada`;
                    log('‚úÖ MP3 listo en servidor. Lanzando Laboratorio...');
                    startAnalysis(result.filename);
                } else {
                    statusDiv.className = 'status-error';
                    statusDiv.innerHTML = `‚ùå Error: ${result.error}`;
                    log(`‚ùå Error servidor: ${result.error}`, 'error');
                }
            } catch (err: any) {
                log(`‚ùå Error de red: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Descargar MP3';
            }
        });

        async function startAnalysis(filename: string) {
            const analysisSection = document.querySelector('#analysisSection') as HTMLElement;
            analysisSection.style.display = 'block';
            termStatus!.textContent = 'BUSY';

            ['A', 'B', 'C'].forEach(id => {
                document.querySelector(`#bpm${id}`)!.textContent = '...';
                document.querySelector(`#status${id}`)!.textContent = 'Analizando...';
            });

            try {
                log(`üì• Descargando buffet: ${filename}`);
                const response = await fetch(`/api/get-audio?filename=${encodeURIComponent(filename)}`);
                const arrayBuffer = await response.arrayBuffer();

                const audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 44100 });
                log('üß† Decodificando audio (CPU intensivo)...');
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const channelData = audioBuffer.getChannelData(0);
                log(`üìä Audio decodificado. Duraci√≥n: ${Math.round(audioBuffer.duration)}s @ 44.1kHz`);

                runEssentia(channelData, audioBuffer.sampleRate);
                runRealtimeBPM(audioBuffer);
                runAubio(channelData, audioBuffer.sampleRate);

            } catch (err: any) {
                log(`üõë Fallo en decodificaci√≥n: ${err.message}`, 'error');
                termStatus!.textContent = 'ERROR';
            }
        }

        // --- Motores (Fixes v0.1.1) ---

        async function runEssentia(signal: Float32Array, sampleRate: number) {
            log('üöÄ Motor A (Essentia): Iniciando...');
            try {
                // Essentia browser initialization is tricky with ESM
                const mod: any = await import('essentia.js');
                
                // Helper to find constructors in the module
                const Essentia = mod.Essentia || mod.default?.Essentia || (mod.default && mod.default);
                const EssentiaWASM = mod.EssentiaWASM || mod.default?.EssentiaWASM;

                log(`üîç Diagn√≥stico A: mod type=${typeof mod}, hasEssentia=${!!Essentia}`);
                
                if (typeof Essentia !== 'function') {
                   throw new Error(`${typeof Essentia} is not a constructor (check module structure)`);
                }

                const essentia = new Essentia(EssentiaWASM);
                log('‚ú® Instancia Essentia creada con √©xito.');

                const vector = essentia.arrayToVector(signal);
                const bpmRes = essentia.PercivalBPM(vector);
                const keyRes = essentia.KeyExtractor(vector);

                document.querySelector('#bpmA')!.textContent = Math.round(bpmRes.bpm).toString();
                document.querySelector('#keyA')!.textContent = `Clave: ${keyRes.key} ${keyRes.scale}`;
                document.querySelector('#statusA')!.textContent = '‚úÖ OK';
                log(`üéØ Motor A finaliz√≥: ${Math.round(bpmRes.bpm)} BPM | ${keyRes.key} ${keyRes.scale}`);
            } catch (e: any) {
                log(`‚ùå Fallo Motor A: ${e.message}`, 'error');
                document.querySelector('#statusA')!.textContent = '‚ùå Error';
            }
        }

        async function runRealtimeBPM(audioBuffer: AudioBuffer) {
            log('üöÄ Motor B (RealtimeBPM): Iniciando...');
            try {
                const mod: any = await import('realtime-bpm-analyzer');
                const analyzeFullBuffer = mod.analyzeFullBuffer || mod.default?.analyzeFullBuffer;

                log(`üîç Diagn√≥stico B: mod type=${typeof mod}, hasAnalyze=${!!analyzeFullBuffer}`);

                if (!analyzeFullBuffer) {
                    throw new Error('Funci√≥n analyzeFullBuffer no encontrada en el m√≥dulo.');
                }

                const results = await analyzeFullBuffer(audioBuffer);
                if (results && results.length > 0) {
                    const best = results[0];
                    document.querySelector('#bpmB')!.textContent = Math.round(best.tempo).toString();
                    document.querySelector('#statusB')!.textContent = '‚úÖ OK';
                    log(`üéØ Motor B finaliz√≥: ${Math.round(best.tempo)} BPM (Confianza: ${best.count})`);
                } else {
                    log('‚ö†Ô∏è Motor B no detect√≥ ritmo claro.', 'warn');
                    document.querySelector('#statusB')!.textContent = '‚ùì Nulo';
                }
            } catch (e: any) {
                log(`‚ùå Fallo Motor B: ${e.message}`, 'error');
                document.querySelector('#statusB')!.textContent = '‚ùå Error';
            }
        }

        async function runAubio(signal: Float32Array, sampleRate: number) {
            log('üöÄ Motor C (Aubio): Iniciando...');
            try {
                const aubiojs = (await import('aubiojs')).default;
                const aubio = await aubiojs();
                
                // Par√°metros para mayor precisi√≥n
                const winSize = 2048;
                const hopSize = 512;
                
                // 1. Detecci√≥n de BPM
                const tempo = new aubio.Tempo(winSize, hopSize, sampleRate);
                let bpms: number[] = [];
                
                // 2. Detecci√≥n de Pitch (para Clave aproximada)
                const pitch = new aubio.Pitch('default', winSize, hopSize, sampleRate);
                let pitches: number[] = [];

                for (let i = 0; i < signal.length; i += hopSize) {
                    const frame = signal.slice(i, i + hopSize);
                    if (frame.length === hopSize) {
                        // Tempo
                        if (tempo.do(frame)) {
                            const b = tempo.getBpm();
                            if (b > 30 && b < 250) bpms.push(b);
                        }
                        // Pitch
                        const p = pitch.do(frame);
                        if (p > 50 && p < 2000) pitches.push(p);
                    }
                }
                
                // Procesar BPM
                if (bpms.length > 0) {
                    bpms.sort((a,b) => a-b);
                    let median = bpms[Math.floor(bpms.length / 2)];
                    
                    // HEUR√çSTICA: Si la mediana est√° cerca de 126 y sospechamos de un arm√≥nico de 84
                    // (126 es 1.5x de 84). Comprobamos si hay muchos valores cerca de 84.
                    const tolerance = 5;
                    const possibleLower = (median * 2) / 3; // 126 -> 84
                    const candidatesLower = bpms.filter(b => Math.abs(b - possibleLower) < tolerance);
                    
                    if (candidatesLower.length > bpms.length * 0.2) {
                        log(`üí° Motor C: Detectada posible armon√≠a. Ajustando ${median.toFixed(1)} -> ${possibleLower.toFixed(1)}`);
                        median = possibleLower;
                    }

                    document.querySelector('#bpmC')!.textContent = Math.round(median).toString();
                    log(`üéØ Motor C finaliz√≥: ${Math.round(median)} BPM`);
                }

                // Procesar Pitch (Clave muy aproximada)
                if (pitches.length > 0) {
                    pitches.sort((a,b) => a-b);
                    const avgPitch = pitches[Math.floor(pitches.length/2)];
                    // Convertir Hz a nota (simplificado)
                    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                    const semitone = 12 * (Math.log(avgPitch / 440) / Math.log(2)) + 69;
                    const noteIndex = Math.round(semitone) % 12;
                    document.querySelector('#keyC')!.textContent = `Clave (Aprox): ${notes[noteIndex]}`;
                }

                document.querySelector('#statusC')!.textContent = '‚úÖ OK';
            } catch (e: any) {
                log(`‚ùå Fallo Motor C: ${e.message}`, 'error');
                document.querySelector('#statusC')!.textContent = '‚ùå Error';
            } finally {
                if (termStatus!.textContent !== 'ERROR') termStatus!.textContent = 'IDLE';
            }
        }
    </script>
</body>
</html>
